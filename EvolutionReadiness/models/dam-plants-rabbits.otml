<?xml version="1.0" encoding="UTF-8"?>
<otrunk id="b37dcbd7-34ad-4187-bff0-f3a42be0b282">
  <imports>
    <import class="org.concord.data.state.OTDataStore" />
    <import class="org.concord.data.state.OTDataChannelDescription" />
    <import class="org.concord.data.state.OTDataField" />
    <import class="org.concord.data.state.OTDataTable" />
    <import class="org.concord.datagraph.state.OTDataGraph" />
    <import class="org.concord.datagraph.state.OTDataAxis" />
    <import class="org.concord.datagraph.state.OTDataGraphable" />
    <import class="org.concord.datagraph.state.OTDataCollector" />
    <import class="org.concord.datagraph.state.OTMultiDataGraph" />
    <import class="org.concord.datagraph.state.OTPluginView" />
    <import class="org.concord.datagraph.state.OTDataBarGraphable" />
    <import class="org.concord.otrunk.OTIncludeRootObject" />
    <import class="org.concord.otrunk.OTInclude" />
    <import class="org.concord.otrunk.OTSystem" />
    <import class="org.concord.otrunk.biologica.OTOrganismPlacement" />
    <import class="org.concord.otrunk.biologica.OTEnvironment" />
    <import class="org.concord.otrunk.biologica.OTOrganism" />
    <import class="org.concord.otrunk.biologica.OTWorld" />
    <import class="org.concord.otrunk.biologica.agent.OTAgentSpecies" />
    <import class="org.concord.otrunk.biologica.agent.OTAgentTrait" />
    <import class="org.concord.otrunk.biologica.agent.OTAgentPropertyImageMap" />
    <import class="org.concord.otrunk.biologica.environment.OTAddAgentButton" />
    <import class="org.concord.otrunk.biologica.environment.OTEnvironmentHolder" />
    <import class="org.concord.otrunk.biologica.data.OTBiologicaModelDataProducer" />
    <import class="org.concord.otrunk.biologica.rules.OTRule" />
    <import class="org.concord.otrunk.biologica.rules.OTRuleCondition" />
    <import class="org.concord.otrunk.biologica.rules.OTRuleConsequence" />
    <import class="org.concord.otrunk.ui.OTCurriculumUnit" />
    <import class="org.concord.otrunk.ui.OTPlacement" />
    <import class="org.concord.otrunk.ui.snapshot.OTSnapshot" />
    <import class="org.concord.otrunk.ui.snapshot.OTSnapshotButton" />
    <import class="org.concord.otrunk.ui.snapshot.OTSnapshotAlbum" />
    <import class="org.concord.otrunk.ui.snapshot.OTSnapshotChooser" />
    <import class="org.concord.otrunk.view.OTViewEntry" />
    <import class="org.concord.otrunk.view.OTViewBundle" />
    <import class="org.concord.otrunk.view.OTViewMode" />
    <import class="org.concord.otrunk.view.document.OTCompoundDoc" />
    <import class="org.concord.otrunk.script.ui.OTScriptObject" />
    <import class="org.concord.otrunk.script.js.OTJavascript" />
    <import class="org.concord.otrunk.script.OTScriptEngineBundle" />
    <import class="org.concord.otrunk.script.OTScriptEngineEntry" />
    <import class="org.concord.otrunk.script.ui.OTScriptVariable" />
    <import class="org.concord.otrunk.script.ui.OTScriptVariableComponent" />
    <import class="org.concord.otrunk.script.ui.OTScriptVariableRealObject" />
    <import class="org.concord.otrunk.script.ui.OTScriptVariableView" />
    <import class="org.concord.otrunk.script.ui.OTScriptButton" />
    <import class="org.concord.otrunk.ui.OTButton" />
    <import class="org.concord.otrunk.ui.OTProgressBar" />
    <import class="org.concord.otrunk.ui.OTSlider" />
    <import class="org.concord.otrunk.ui.OTSliderLabel" />
    <import class="org.concord.otrunk.ui.OTText" />
    <import class="org.concord.framework.otrunk.view.OTFrame" />
    <import class="org.concord.framework.otrunk.wrapper.OTObjectSet" />
  </imports>
  <idMap>
    <idMapping local_id="rabbit-species" id="8b5a6e28-684f-4673-b1d2-19a0c9b044be" />
    <idMapping local_id="plant-species" id="6904840c-03f6-4f2d-b822-bc85aebe70db" />
  </idMap>
  <objects>
    <OTSystem>
      <bundles>
        <object refid="8d880970-c22a-11dc-95ff-0800200c9a66" />
        <OTViewBundle>
          <frame>
            <OTFrame useScrollPane="false" openMaximized="false" width="900" height="500" />
          </frame>
        </OTViewBundle>
        <OTScriptEngineBundle>
          <engines>
            <OTScriptEngineEntry objectClass="org.concord.otrunk.script.js.OTJavascript" engineClass="org.concord.otrunk.script.js.OTJavascriptEngine" />
          </engines>
        </OTScriptEngineBundle>
      </bundles>
      <includes>
        <OTInclude href="../global-imports/er-view-bundle.otml" />
        <OTInclude href="species/fast-plants-roots.otml" />
        <OTInclude href="species/varied-rabbits.otml" />
      </includes>
      <root>
        <OTCompoundDoc>
          <bodyText>
            <table>
              <tr>
                <td>
                  <object refid="${env-holder}" />
                </td>
                <td>
                  <object refid="${dam-button}" />
                  <br />
                  <br />
                  <table>
                    <tr>
                      <td align="center">
                        <b>Water below the dam</b>
                        <br />
                        <br />
                        Lots of water
                        <br/>
                        <object refid="${water-slider}" />
                        <br />
                        Little water
                        <br />
                      </td>
                    </tr>
                  </table>
                  <object refid="${script}" />
                </td>
              </tr>
            </table>
          </bodyText>
          <documentRefs>
            <OTEnvironmentHolder local_id="env-holder" width="590" height="460" toolbar="run,reset,info" useSpeedSlider="false">
              <environment>
                <OTEnvironment local_id="environment" environmentWidth="25" environmentHeight="25" showRunButton="false" winterLength="5" summerLength="50" showWinterImage="false" orgSizeMultiplier="1.8" backgroundImageSrc="images/dam-year0.jpg">
                  <world>
                    <OTWorld local_id="peasimple_world" speciesPath="org/concord/biologica/worlds/peasimple.xml" />
                  </world>
                  <rules>
                    <OTRule description="roots 1 needs lots of water">
                      <conditions>
                        <OTRuleCondition property="species name" equals="Fast Plants" />
                        <OTRuleCondition property="roots" equalsValue="1.0" />
                      </conditions>
                      <consequences>
                        <!-- chance of survival is 1.0 at watdarn.er > 0.9, 0.8 at water < 0.5, and decreases linearly between -->
                        <OTRuleConsequence property="chance of survival" ruleScript="var distFrom90 = Math.max(0.9-water, 0.0); var dryness = Math.min(1.0, distFrom90/0.4);  return 1 - (dryness * 0.2)">
                          <propertyVariables>
                            <string>water</string>
                          </propertyVariables>
                        </OTRuleConsequence>
                        <!-- growth rate is 0.04 at water > 0.9, 0 at water < 0.5, and decreases linearly between  -->
                        <OTRuleConsequence property="growth rate" ruleScript="var distFrom90 = Math.max(0.9-water, 0.0); var dryness = Math.min(1.0, distFrom90/0.4); return 0.04 - (dryness * .04) + population_size_modifier">
                          <propertyVariables>
                            <string>water</string>
                            <string>population size modifier</string>
                          </propertyVariables>
                        </OTRuleConsequence>
                      </consequences>
                    </OTRule>
                    <OTRule description="roots 2 needs medium of water">
                      <conditions>
                        <OTRuleCondition property="species name" equals="Fast Plants" />
                        <OTRuleCondition property="roots" equalsValue="2.0" />
                      </conditions>
                      <consequences>
                        <!-- chance of survival is 1.0 at water > 0.7, 0.8 at water < 0.3, and decreases linearly between -->
                        <OTRuleConsequence property="chance of survival" ruleScript="var distFrom70 = Math.max(0.7-water, 0.0); var dryness = Math.min(1.0, distFrom70/0.4); return 1 - (dryness * 0.2)">
                          <propertyVariables>
                            <string>water</string>
                          </propertyVariables>
                        </OTRuleConsequence>
                        <!-- growth rate is 0.04 at water > 0.7, 0 at water < 0.3, and decreases linearly between  -->
                        <OTRuleConsequence property="growth rate" ruleScript="var distFrom70 = Math.max(0.7-water, 0.0); var dryness = Math.min(1.0, distFrom70/0.4); return 0.04 - (dryness * .04) + population_size_modifier">
                          <propertyVariables>
                            <string>water</string>
                            <string>population size modifier</string>
                          </propertyVariables>
                        </OTRuleConsequence>
                      </consequences>
                    </OTRule>
                    <OTRule description="roots e doesn't care">
                      <conditions>
                        <OTRuleCondition property="species name" equals="Fast Plants" />
                        <OTRuleCondition property="roots" equalsValue="3.0" />
                      </conditions>
                      <consequences>
                        <!-- growth rate is 0.04  -->
                        <OTRuleConsequence property="growth rate" ruleScript="return 0.04 + population_size_modifier">
                          <propertyVariables>
                            <string>population size modifier</string>
                          </propertyVariables>
                        </OTRuleConsequence>
                      </consequences>
                    </OTRule>
                  </rules>
                  <barriers>
                    <OTPlacement x="0" y="120" width="250" height="9" />
                  </barriers>
                </OTEnvironment>
              </environment>
              <addAgentsButtons>
                <OTAddAgentButton text="Add Plant A" limit="180" click="false" quantity="60">
                  <species>
                    <object refid="6904840c-03f6-4f2d-b822-bc85aebe70db" />
                  </species>
                  <agentTraits>
                    <OTAgentTrait property="roots">
                      <possibleValues>
                        <int>1</int>
                        <int>2</int>
                        <int>3</int>
                      </possibleValues>
                    </OTAgentTrait>
                    <OTAgentTrait property="growth rate">
                      <defaultValues>
                        <float>0.04</float>
                      </defaultValues>
                    </OTAgentTrait>
                    <OTAgentTrait property="age of maturity">
                      <defaultValues>
                        <int>15</int>
                      </defaultValues>
                    </OTAgentTrait>
                    <OTAgentTrait property="population size modifier">
                      <defaultValues>
                        <float>0.0</float>
                      </defaultValues>
                    </OTAgentTrait>
                  </agentTraits>
                </OTAddAgentButton>
                <OTAddAgentButton text="Add Rabbits" limit="30" click="false" quantity="10">
                  <species>
                    <object refid="8b5a6e28-684f-4673-b1d2-19a0c9b044be" />
                  </species>
                </OTAddAgentButton>
              </addAgentsButtons>
              <traitsToShow>
                <string>chance of survival</string>
              </traitsToShow>
            </OTEnvironmentHolder>
            <OTScriptObject local_id="script" name="Setup script">
              <script>
                <OTJavascript src="scripts/gradated-sunlight-five-blocks/setup.js">
                  <script>importPackage(Packages.java.lang);
                        importPackage(Packages.java.awt);
                        importPackage(Packages.java.net);
                        importPackage(Packages.org.concord.biologica.environment);
                        importPackage(Packages.org.concord.framework.otrunk);
                        
                        var damCreated = false;
                        var startTime
                        var time
                        var previousTime
                        var isRunning = false
                        var recentlyChangedWater = true      // added a rabbit this past second
              
                        var CHANGE_WATER_RATE = 2;     // seconds before drying out environment
                        var currentWater = 1.0;
                        
                        
                        var baseUrl = otEnvHolder.getOTObjectService().getCodebase(otEnvHolder)

                        function init() {
                          env.removeAllAgents()
                          env.setStepCount(0)
                          envHolder.pauseAction()
                          env.setWrapNorthSouth(false)
                          env.setWrapEastWest(false)
                          
                          
                          var url = new URL(baseUrl, "images/dam-year1.jpg")
                          envHolder.getEnvironmentView().addBackgroundImageUrl(url)
                          var url2 = new URL(baseUrl, "images/dam-year2.jpg")
                          envHolder.getEnvironmentView().addBackgroundImageUrl(url2)
                          var url3 = new URL(baseUrl, "images/dam-year3.jpg")
                          envHolder.getEnvironmentView().addBackgroundImageUrl(url3)
                          var url4 = new URL(baseUrl, "images/dam-year4.jpg")
                          envHolder.getEnvironmentView().addBackgroundImageUrl(url4)
                          var url5 = new URL(baseUrl, "images/dam-year5.jpg")
                          envHolder.getEnvironmentView().addBackgroundImageUrl(url5)
                          var url6 = new URL(baseUrl, "images/dam-year6.jpg")
                          envHolder.getEnvironmentView().addBackgroundImageUrl(url6)
                          var url7 = new URL(baseUrl, "images/dam-year7.jpg")
                          envHolder.getEnvironmentView().addBackgroundImageUrl(url7)
                          var url8 = new URL(baseUrl, "images/dam-year8.jpg")
                          envHolder.getEnvironmentView().addBackgroundImageUrl(url8)
                          var url9 = new URL(baseUrl, "images/dam-year9.jpg")
                          envHolder.getEnvironmentView().addBackgroundImageUrl(url9)
                          var url10 = new URL(baseUrl, "images/dam-year10.jpg")
                          envHolder.getEnvironmentView().addBackgroundImageUrl(url10)
                          
                          
                          env.addStepListener(stepListener)
                          env.addChangeListener(resetListener)
                          damButton.addOTChangeListener(damButtonListener)
                          
                          setup();
  
                          return true;
                        }
                        
                        function setup() {
                          var url = new URL(baseUrl, "images/dam-year0.jpg");
                          envHolder.getEnvironmentView().setBackgroundImageUrl(url);
                          damCreated = false
                          damButton.setEnabled(true);
                          
                          recentlyChangedWater = true
                          time = 0
                          previousTime = 0
                          
                          setPropertyOnEnvironment("water", 1.0, false)
                          currentWater = 1.0
                          slider.setValue(100)
                        }
                        
                        var damButtonHandler =
												{
												    stateChanged: function(evt)
												    {
												      if (damButton.getClicked()){
												        createDam();
												      }
												    }
												
												}
												var damButtonListener = new OTChangeListener(damButtonHandler)
                        
              function createDam() {
                if (!damCreated) {
                  damCreated = true;
                  startTime = System.currentTimeMillis();
                  damButton.setEnabled(false);
                  makeDrier();
                }
              }
                        
              var stepHandler =
              {
                environmentStepped: function()
                {
                  if (damCreated) {
                    updateTimer();
                    checkWaterUpdating();
                   }
                   setPlantGrowthRate();
                }
              }
              var stepListener = new EnvironmentStepListener(stepHandler)
              
              var resetRunHandler= {
                  environmentChanged: function(evt){
                    if (evt.getType() == EnvironmentChangeEvent.RESET){
                      isRunning = false
                      setup()
                    } else if (evt.getType() == EnvironmentChangeEvent.RUN){
                      isRunning = true
                      if (damCreated) { 
                        startTime = System.currentTimeMillis()
                       }
                    } else if (evt.getType() == EnvironmentChangeEvent.PAUSE){
                      previousTime = time;
                    }
                  }
                }
                      
              var resetListener = new EnvironmentChangeListener(resetRunHandler)
              
              function updateTimer(){
                timeSinceLastStart = System.currentTimeMillis() - startTime;
                time =  previousTime + timeSinceLastStart;
              }
              
              function checkWaterUpdating(){
                seconds = Math.floor(time / 1000);
                if (seconds % CHANGE_WATER_RATE == 0){
                  if (!recentlyChangedWater) {
                    recentlyChangedWater = true;
                    makeDrier();
                  }
                } else {
                  recentlyChangedWater = false;
                }
              }
              
              function makeDrier() {
                if (currentWater &gt; 0){
                  currentWater -= 0.02;
                }
                setPropertyOnEnvironment("water", currentWater, true);
                slider.setValue(currentWater * 100);
                
                if (currentWater &gt; 0.9){
                  var url = new URL(baseUrl, "images/dam-year1.jpg")
                } else if (currentWater &gt; 0.8){
                  var url = new URL(baseUrl, "images/dam-year2.jpg")
                } else if (currentWater &gt; 0.7){
                  var url = new URL(baseUrl, "images/dam-year3.jpg")
                }else if (currentWater &gt; 0.6){
                  var url = new URL(baseUrl, "images/dam-year4.jpg")
                }else if (currentWater &gt; 0.5){
                  var url = new URL(baseUrl, "images/dam-year5.jpg")
                }else if (currentWater &gt; 0.4){
                  var url = new URL(baseUrl, "images/dam-year6.jpg")
                }else if (currentWater &gt; 0.3){
                  var url = new URL(baseUrl, "images/dam-year7.jpg")
                }else if (currentWater &gt; 0.2){
                  var url = new URL(baseUrl, "images/dam-year8.jpg")
                }else if (currentWater &gt; 0.1){
                  var url = new URL(baseUrl, "images/dam-year9.jpg")
                }else {
                  var url = new URL(baseUrl, "images/dam-year10.jpg")
                }
                envHolder.getEnvironmentView().setBackgroundImageUrl(url)
              }
                        
                        function setPropertyOnEnvironment(prop, val, halfOnly){
                            var cols = env.getColumns();
                            var rows = env.getRows();
                            var startRow = halfOnly ? rows/2 : 0;
                            for (var i = 0; i &lt; cols; i++) {
                              for (var j = startRow; j &lt; rows; j++) {
                                env.getEnvironmentUnit(i,j).setProperty(prop, new Float(val))
                              }
                            }
                        }
                        
function setPlantGrowthRate(){
  var allPlants = env.getAgents(plantspecies); 
  var varieties = [[], [], [], [], [], []];
  for (var i = 0; i &lt; allPlants.size(); i++){
    var plant = allPlants.get(i);
    var rootSize = plant.getProperty("roots");
    var adder = (plant.getLocation().y &gt; 125) ? 3 : 0;
    varieties[((rootSize - 1) + adder)].push(plant);
  }
  
  
  //  System.out.println(":" + varieties[0].length + ", " + varieties[1].length + ", " +  varieties[2].length + ":" + varieties[3].length + ", " + varieties[4].length + ", " +  varieties[5].length);
  
  for (var i = 0; i &lt; 6; i++){
    setGrowthRateForVariety(varieties[i]);
  }
}
                        
function setGrowthRateForVariety(plants)
{
  var plantSize = plants.length;
  var populationSizeModifier = 0.0;
  if (plantSize &lt; 8) {
    populationSizeModifier = 0.6;
  } else if (plantSize &lt; 15) {
    populationSizeModifier = 0.3;
  } else if (plantSize &lt; 20) {
    populationSizeModifier = 0.1;
  } else if (plantSize &lt; 40) {
    populationSizeModifier = 0.0;
  } else if (plantSize &lt; 100) {
    populationSizeModifier = -0.02;
  } else if (plantSize &lt; 130) {
    populationSizeModifier = -0.03;
  } else if (plantSize &lt; 160) {
    populationSizeModifier = -0.05;
  }
  
  for (var i = 0; i &lt; plantSize; i++){
    plants[i].setProperty("population size modifier", populationSizeModifier);
  }
}

                        function save() {
                          return true;
                        }</script>
                </OTJavascript>
              </script>
              <variables>
                <OTScriptVariableRealObject name="env">
                  <reference>
                    <object refid="${environment}" />
                  </reference>
                </OTScriptVariableRealObject>
                <OTScriptVariableRealObject name="envHolder">
                  <reference>
                    <object refid="${env-holder}" />
                  </reference>
                </OTScriptVariableRealObject>
                <OTScriptVariable name="otEnvHolder">
                  <reference>
                    <object refid="${env-holder}" />
                  </reference>
                </OTScriptVariable>
                <OTScriptVariableRealObject name="holder">
                  <reference>
                    <object refid="${env-holder}" />
                  </reference>
                </OTScriptVariableRealObject>
                <OTScriptVariable name="slider">
                  <reference>
                    <object refid="${water-slider}" />
                  </reference>
                </OTScriptVariable>
                <OTScriptVariable name="damButton">
                  <reference>
                    <object refid="${dam-button}" />
                  </reference>
                </OTScriptVariable>
                <OTScriptVariableRealObject name="plantspecies">
                  <reference>
                    <object refid="${plant-species}" />
                  </reference>
                </OTScriptVariableRealObject>
              </variables>
              <scriptState />
            </OTScriptObject>
            <OTProgressBar local_id="water-slider" minimum="30" maximum="100" value="100" vertical="true" />
            <OTButton local_id="dam-button" text="Build Dam" enabled="true" />
          </documentRefs>
        </OTCompoundDoc>
      </root>
    </OTSystem>
  </objects>
</otrunk>

